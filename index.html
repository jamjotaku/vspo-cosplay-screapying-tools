<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VSPO! Cosplay Archive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Zen Maru Gothic', sans-serif; background-color: #fdfbf7; }
        .card:hover { transform: translateY(-5px); }
        .tweet-text { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        /* èª­ã¿è¾¼ã¿ä¸­ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼ */
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #6366f1; border-radius: 50%;
            width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-800">

    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center gap-8">
                <h1 class="text-2xl font-bold text-indigo-600 tracking-tight">
                    <a href="index.html">VSPO! Cosplay</a>
                </h1>
                <nav class="hidden md:flex gap-1 bg-gray-100 p-1 rounded-lg">
                    <a href="index.html" class="px-4 py-1.5 rounded-md text-sm font-bold bg-white text-indigo-600 shadow-sm transition">
                        ã‚®ãƒ£ãƒ©ãƒªãƒ¼
                    </a>
                    <a href="analytics.html" class="px-4 py-1.5 rounded-md text-sm font-bold text-gray-500 hover:text-indigo-600 transition">
                        ãƒ‡ãƒ¼ã‚¿åˆ†æ
                    </a>
                </nav>
            </div>
            <div class="text-xs text-gray-400" id="last-updated">Updating...</div>
        </div>
    </header>

    <div class="md:hidden flex justify-center py-2 bg-white border-b border-gray-100 gap-4 text-sm font-bold">
        <a href="index.html" class="text-indigo-600 border-b-2 border-indigo-600">ã‚®ãƒ£ãƒ©ãƒªãƒ¼</a>
        <a href="analytics.html" class="text-gray-400">ãƒ‡ãƒ¼ã‚¿åˆ†æ</a>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-6 overflow-x-auto whitespace-nowrap scrollbar-hide">
        <div id="filter-container" class="flex gap-2 pb-2">
            </div>
    </div>

    <main class="max-w-7xl mx-auto px-4 pb-12">
        <div id="gallery-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            </div>

        <div id="loading-indicator" class="text-center py-10">
            <div class="loader"></div>
            <p class="text-gray-400 text-sm">Loading more...</p>
        </div>
        
        <div id="end-message" class="hidden text-center py-10 text-gray-400">
            ã“ã‚Œä»¥ä¸Šãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ ğŸ‰
        </div>
    </main>

    <script>
        // --- è¨­å®š ---
        const PAGE_SIZE = 24; // ä¸€åº¦ã«èª­ã¿è¾¼ã‚€æšæ•°
        
        // --- çŠ¶æ…‹ç®¡ç† ---
        let allData = [];
        let filteredData = [];
        let currentIndex = 0;
        let isLoading = false;

        // --- åˆæœŸåŒ– ---
        async function loadData() {
            try {
                const response = await fetch('collect.json');
                const data = await response.json();
                
                // æ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆ (CSVãƒ‡ãƒ¼ã‚¿ã‚‚è€ƒæ…®ã—ã¦ collected_at ãŒãªã„å ´åˆã¯å¾Œã‚ã¸)
                allData = data.sort((a, b) => {
                    const dateA = a.collected_at ? new Date(a.collected_at) : new Date(0);
                    const dateB = b.collected_at ? new Date(b.collected_at) : new Date(0);
                    return dateB - dateA;
                });
                
                filteredData = allData;
                
                // ãƒ˜ãƒƒãƒ€ãƒ¼æ›´æ–°
                if(allData.length > 0) {
                    const lastDate = new Date(allData[0].collected_at);
                    if (!isNaN(lastDate)) {
                        document.getElementById('last-updated').textContent = `æœ€çµ‚æ›´æ–°: ${lastDate.toLocaleString('ja-JP')}`;
                    }
                }

                renderFilters();
                renderNextBatch(); // æœ€åˆã®24ä»¶ã‚’è¡¨ç¤º

            } catch (error) {
                console.error("Error loading data:", error);
                document.getElementById('gallery-grid').innerHTML = `<div class="col-span-full text-center text-red-500">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>${error}</div>`;
                document.getElementById('loading-indicator').style.display = 'none';
            }
        }

        // --- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³æç”» ---
        function renderFilters() {
            const container = document.getElementById('filter-container');
            container.innerHTML = '';

            // ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ã‚’å–å¾—ï¼ˆé‡è¤‡æ’é™¤ï¼‰
            const members = ['ALL', ...new Set(allData.map(item => item.member_name).filter(n => n))];
            
            members.forEach(member => {
                const btn = document.createElement('button');
                const isAll = member === 'ALL';
                btn.className = `filter-btn px-4 py-2 rounded-full text-sm font-bold shadow-sm transition border ${isAll ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-gray-600 border-gray-200 hover:bg-indigo-50 hover:text-indigo-600'}`;
                btn.textContent = member;
                btn.dataset.member = member;
                
                btn.onclick = () => applyFilter(member);
                container.appendChild(btn);
            });
        }

        // --- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ ---
        function applyFilter(memberName) {
            // ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«åˆ‡ã‚Šæ›¿ãˆ
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.dataset.member === memberName) {
                    btn.className = "filter-btn px-4 py-2 rounded-full text-sm font-bold shadow-md transition border bg-indigo-600 text-white border-indigo-600";
                } else {
                    btn.className = "filter-btn px-4 py-2 rounded-full text-sm font-bold shadow-sm transition border bg-white text-gray-600 border-gray-200 hover:bg-indigo-50 hover:text-indigo-600";
                }
            });

            // ãƒ‡ãƒ¼ã‚¿ã®çµã‚Šè¾¼ã¿
            if (memberName === 'ALL') {
                filteredData = allData;
            } else {
                filteredData = allData.filter(item => item.member_name === memberName);
            }

            // è¡¨ç¤ºãƒªã‚»ãƒƒãƒˆ
            currentIndex = 0;
            document.getElementById('gallery-grid').innerHTML = '';
            document.getElementById('end-message').classList.add('hidden');
            document.getElementById('loading-indicator').style.display = 'block';
            
            renderNextBatch();
        }

        // --- ç”»åƒã‚«ãƒ¼ãƒ‰ç”Ÿæˆ (é…å»¶èª­ã¿è¾¼ã¿å¯¾å¿œ) ---
        function renderNextBatch() {
            if (isLoading) return;
            isLoading = true;

            const container = document.getElementById('gallery-grid');
            const endMessage = document.getElementById('end-message');
            const loadingIndicator = document.getElementById('loading-indicator');

            // æ¬¡ã®ãƒãƒƒãƒã‚’å–å¾—
            const nextBatch = filteredData.slice(currentIndex, currentIndex + PAGE_SIZE);

            if (nextBatch.length === 0) {
                loadingIndicator.style.display = 'none';
                if (currentIndex > 0) endMessage.classList.remove('hidden');
                isLoading = false;
                return;
            }

            // HTMLç”Ÿæˆ
            const fragment = document.createDocumentFragment();
            nextBatch.forEach(item => {
                // ç”»åƒãŒãªã„ãƒ‡ãƒ¼ã‚¿ã¯ã‚¹ã‚­ãƒƒãƒ—
                if (!item.images || item.images.length === 0) return;

                const displayImage = item.images[0];
                const likes = item.like_count ? item.like_count.toLocaleString() : 0;
                
                // contentãŒé•·ã„å ´åˆã‚„ã€ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®å‡¦ç†
                let displayText = item.content || "";
                if (item.author_name) displayText = `Cosplayer: ${item.author_name}`;

                const card = document.createElement('div');
                card.className = "card bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100 transition duration-300 flex flex-col";
                card.innerHTML = `
                    <a href="${item.url}" target="_blank" class="block relative group h-64 overflow-hidden bg-gray-100">
                        <img src="${displayImage}" loading="lazy" alt="${item.member_name}" class="w-full h-full object-cover object-top transition duration-500 group-hover:scale-105">
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition"></div>
                        <div class="absolute top-2 right-2 bg-black bg-opacity-60 text-white text-xs px-2 py-1 rounded">
                            ${item.images.length}æš
                        </div>
                    </a>
                    <div class="p-4 flex flex-col flex-grow">
                        <div class="flex justify-between items-start mb-2">
                            <span class="bg-indigo-100 text-indigo-800 text-xs font-bold px-2 py-0.5 rounded">
                                ${item.member_name}
                            </span>
                            <div class="flex items-center gap-2 text-xs text-gray-400">
                                <span>${item.source === 'Instagram' ? 'ğŸ“·' : 'ğŸ¦'}</span>
                                <span class="flex items-center gap-0.5 text-pink-500 font-bold">
                                    â¤ï¸ ${likes}
                                </span>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mb-3 tweet-text flex-grow">${displayText}</p>
                    </div>
                `;
                fragment.appendChild(card);
            });

            container.appendChild(fragment);
            currentIndex += nextBatch.length;
            isLoading = false;

            // ãƒ‡ãƒ¼ã‚¿ãŒå°½ããŸã‹ãƒã‚§ãƒƒã‚¯
            if (currentIndex >= filteredData.length) {
                loadingIndicator.style.display = 'none';
                endMessage.classList.remove('hidden');
            }
        }

        // --- ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ¤œçŸ¥ ---
        window.addEventListener('scroll', () => {
            if (isLoading) return;
            // ç”»é¢ã®ä¸‹ç«¯è¿‘ãã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãŸã‚‰æ¬¡ã‚’èª­ã¿è¾¼ã‚€
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
                renderNextBatch();
            }
        });

        // é–‹å§‹
        loadData();

    </script>
</body>
</html>